# ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³
# DAN started 2.2 Setting up automatic deploy when pushing code
#  this was my first material use of GHA, and here on 2.7 i think it's almost done!
#
# GOOD DOCS
# Github Actions 'on' event types: https://docs.github.com/en/actions/reference/events-that-trigger-workflows
#   same doc? https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows
#
# ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³




name: 5 Build-Push-Run Image

on: 
  workflow_dispatch:
#  push:
#    branches: [ main ]
#  pull_request:
#    branches: [ main ]

jobs:
  build-push-run-job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: 1 Starting the Build'n'Push Process -------------------------
        run: echo "Starting up Checkout and the process in the ${{ github.event.inputs.environment }} env"


#       run docker build -t aqua-server-1 ../aqua-server-go --tag my-aqua-server-tag:$(date +%s) # this also works, but just creates another image which i dont need
      - name: 2 Build the Docker Image -------------------------
        run: |
          docker build -t aqua-server-1 ../aqua-server-go
          ls -al
          pwd


      - name: 3 Authenticate GHA with AWS -------------------------
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1


# DANLATER i need to check why the size that ECR shows the image being 100mb is so much smaller than locally 400mb (compressed?)
# DANLATER get rid of the sleep value below and replace with an if conditional or needs or something
# DANLATER fix this password warning
#         WARNING! Your password will be stored unencrypted in /home/runner/.docker/config.json.
#         Configure a credential helper to remove this warning. See
#         https://docs.docker.com/engine/reference/commandline/login/#credentials-store
      - name: 3a. Login to ECR -------------------------
        run: |
          echo
          echo "ğŸ”ğŸ”ğŸ”ğŸ” aws ecr get-login-password blah blah ğŸ”ğŸ”ğŸ”ğŸ”"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin 535002851677.dkr.ecr.us-east-1.amazonaws.com
          echo "ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”ğŸ”"


      - name: 4 Tag the Image (never been sure why) and then list the images that exist -------------------------
        run: |
          echo
          echo "ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ docker images ğŸ³ 1st view ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³"
          docker images
          docker tag aqua-server-1:latest 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name:latest
          sleep 4
          echo "ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ docker images ğŸ³ 2nd view ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³"
          docker images
          echo "ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³"
          docker ps
# DAN reminder remove the sleep call above


      - name: 5 Push the Image to ECR -------------------------
        run: |
          echo dwc region is ${{ env.AWS_REGION }} PERIOD
          echo dwc key is ${{ secrets.AWS_ACCESS_KEY_ID }} PERIOD
          echo dwc ACcouNT is ${{ env.AWS_ACCOUNT_ID }} PERIOD
          echo "ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ docker images ğŸ³ immediately before PUSH ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³"
          docker images
          echo "ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³ğŸ³"
          docker push 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name:latest
          
 # Warning - if i ever change the tagging of 'aqua-subnet-public' in TF, this will break
 # DANTODO 2.7: replace these hardcoded values with env variables, and ideally the vars that i defined in tfvars
      - name: 5a Set up env variables from AWS to run image
        id: aqua-subnet-step
        run: |
          echo "DANTODO: replace this awful SUBNET greg/regex with a data resource in TF"
          echo "aqua_subnet=$(aws ec2 describe-subnets --filters Name=tag:Name,Values=aqua-subnet-public | grep SubnetId | tr -d '",' | xargs | cut -d' ' -f2)" >> $GITHUB_ENV
        
      - name: 5b Print out aqua subnet 58937
        id: aqua-subnet-step-confirm
        run: |
          echo "ğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µ Aqua Subnet ID ğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µ"
          echo "${{ env.aqua_subnet }}" 
          echo "ğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µ end Aqua Subnet ID ğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µğŸ§µ"

# DANTODO 2.7: replace these hardcoded values with env variables, and ideally the vars that i defined in tfvars
      - name: 5c Set up env variables from AWS to run image
        id: aqua-security-step
        run: |
          echo "DANTODO 2.9.25: replace this SEC-GROUP greg/regex with a data resource in TF"
          echo "aqua_security_group=$(aws ec2 describe-security-groups --filters Name=group-name,Values=aqua-security-group18 | grep GroupId | tr -d '",' | xargs | cut -d' ' -f2)" >> $GITHUB_ENV
        
      - name: 5d Print out aqua subnet 58937
        id: aqua-security-step-confirm
        run: |
          echo "ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘› Aqua Security Group ID ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›"
          echo "${{ env.aqua_security_group }}" 
          echo "ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘› end Aqua Sec Group ID ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›ğŸ‘›"




      - name: 6 Info specificaly in AWS re ECR, ECS, Container, Tasks, Services
        run: |
          echo
          echo "ğŸ©±ğŸ©±ğŸ©±ğŸ©±ğŸ©± aws EC2 describe-instances ğŸ©±ğŸ©±ğŸ©±ğŸ©±ğŸ©±"
          aws ec2 describe-instances
          echo "ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ aws ecs list-clusters ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨"
          aws ecs list-clusters
          echo "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© aws ecs describe-clusters (reminder: must explicitly pass cluster name) ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©"
          aws ecs describe-clusters --cluster arn:aws:ecs:us-east-1:535002851677:cluster/aqua-ecs-cluster-name
          echo "ğŸŸï¸ğŸŸï¸ğŸŸï¸ğŸŸï¸ aws ecs list-container-instances --cluster aqua-ecs-cluster-name ğŸŸï¸ empty for now since Fargate is not exposed here (will see when i go to EC2) ğŸŸï¸ğŸŸï¸ğŸŸï¸ğŸŸï¸"
          aws ecs list-container-instances --cluster aqua-ecs-cluster-name
          echo "ğŸ’™ğŸ’™ğŸ’™ğŸ’™ aws ecs list-task-definitions ğŸ’™ Should have the TF definition for Aqua ğŸ’™ğŸ’™ğŸ’™ğŸ’™"
          aws ecs list-task-definitions
          echo "ğŸŸªğŸŸªğŸŸªğŸŸª aws ecs list-services --cluster aqua-ecs-cluster-name ğŸŸª Once running it should show aqua service ğŸŸªğŸŸªğŸŸªğŸŸª"
          aws ecs list-services --cluster aqua-ecs-cluster-name
          echo "ğŸŸ§ğŸŸ§ğŸŸ§ğŸŸ§ aws ecs list-tasks --cluster arn:aws:ecs:us-east-1:535002851677:cluster/aqua-ecs-cluster-name ğŸŸ§ğŸŸ§ğŸŸ§ğŸŸ§"
          aws ecs list-tasks --cluster arn:aws:ecs:us-east-1:535002851677:cluster/aqua-ecs-cluster-name
          echo "â¬â¬â¬â¬â¬â¬â¬â¬â¬â¬â¬ DONE â¬â¬â¬â¬â¬â¬â¬â¬â¬â¬â¬"


# # ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ 
# DANLATER i need to switch to EC2 not FARGATE
# DANLATER TODO - must add to my TF code a 'force_delete' for the container on ECS and also the image on ECR 
# DANLATER - i have to delete all the images in ECR upon TF destroy
# DANLATER - remove all the hardcoded values below and replace with vars
# DANLATER -   better yet, follow rampals advice using data resources in TF to get the values
# DANTODO - TF destroy needs to delete the ECS service and the ECR image
#
#  DANTODO: i should check if a service is already running and skip this if so (so i dont get that idempotent error)

      - name: 7 Create the Service, ie Run the Image -------------------------
        env: 
          ECR_SEC_GROUP: ${{ env.aqua_security_group}}
          ECR_SUBNET: ${{ env.aqua_subnet}}
        run: |
          echo
          echo "ECR SECURITY GROUP >> $ECR_SEC_GROUP <<"
          echo "ECR SUBNET $ECR_SUBNET <<"
          echo "ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ aws ecs create-service ğŸ’„ Run the container ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„"
          aws ecs create-service \
            --cluster aqua-ecs-cluster-name \
            --task-definition aqua-ecs-task-family \
            --enable-execute-command \
            --service-name aqua-ecs-soiviss \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$ECR_SUBNET],securityGroups=[$ECR_SEC_GROUP],assignPublicIp=ENABLED}" \
            --desired-count 1
          echo "ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„ğŸ’„"


# Get variables to determine IP of the service
# DANHERE 2.9 1014am: this is broken b/c aqua_task_arn is never getting created - maybe i need to sleep or wait till previous step is done
      - name: 8 grab vars 872527
        id: varsstuff-872527
        run: |
          echo
          echo sleeping 150
          sleep 210
          echo "get the task arn"
          echo "aqua_task_arn=$(aws ecs list-tasks --cluster arn:aws:ecs:us-east-1:535002851677:cluster/aqua-ecs-cluster-name | grep :task | sed 's/[[:space:]]//g' | sed 's/"//g')" >> $GITHUB_ENV
          echo "${{ env.aqua_task_arn }}" 
          echo "dan done 987238"


      - name: tempaaaaa
        run: |
          echo 
          echo "TRY TRY Aagin"
          echo "${{ env.aqua_task_arn }}" 
          echo "dan done 2379872r98yhw"


      - name: 9 Get ENI -------------------------
        env: 
          TASK_ARN: ${{ env.aqua_task_arn}}
        run: |
          echo
          echo "aqua_eni=$(aws ecs describe-tasks --cluster arn:aws:ecs:us-east-1:535002851677:cluster/aqua-ecs-cluster-name --tasks arn:aws:ecs:us-east-1:535002851677:task/aqua-ecs-cluster-name/97fc65156c0a40eab0105f500d400fe3 | grep -o 'eni-[^"]*')" >> $GITHUB_ENV
          echo "sleeping to allow eni to get created"
          sleep 30
          echo " ok is the ENI here >>${{ env.aqua_eni }} <<"

          

      - name: 10 finally get the ip -------------------------
        env: 
          AQUA_ENI_YUP: ${{ env.aqua_eni }}
        run: |
          echo
          echo "AQUA ENI: $AQUA_ENI_YUP OOOOOOO"
          echo "aqua_public_ip=$(aws ec2 describe-network-interfaces --network-interface-ids $AQUA_ENI_YUP | grep PublicIp | head -n 1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')" >> $GITHUB_ENV
          echo "${{ env.aqua_public_ip }}"
          


      - name: 9 Get ENI -------------------------
        env: 
          WEBSITE_IP: ${{ env.aqua_public_ip }}
        run: |
          echo
          echo "ğŸ¤ğŸ¤ğŸ¤ğŸ¤ğŸ¤ ğŸ¤ğŸ¤ğŸ¤ go to $WEBSITE_IP"

    
              
