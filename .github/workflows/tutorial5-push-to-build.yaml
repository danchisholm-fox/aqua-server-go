###################################################
# DAN 2.2 Setting up automatic deploy when pushing code
####### #####   ############  ##################
#
# ref doc: https://docs.github.com/en/actions/about-github-actions/understanding-github-actions
# DANHERE 2.2 930pm: the 'deploy' command below works, now need to try 'build' then docker to ECR
#
# GOOD DOCS
# Github Actions 'on' event types: https://docs.github.com/en/actions/reference/events-that-trigger-workflows
#   same doc? https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows
# Github Container Registry: https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry
#     sheesh how many registries do i need - ECR, DockerHub, Github Container Registry
###################################################


###################################################
name: 5 Push to Build

on: 
  workflow_dispatch:
# DAN 2.4.539pm: commenting out just so i can manually run while i test
#  push:
#    branches: [ main ]
#  pull_request:
#    branches: [ main ]

jobs:
  buildDahImage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: 1 Starting the Build'n'Push Process -------------------------
        run: echo "Starting up Checkout and the process in the ${{ github.event.inputs.environment }} env"


#       run docker build -t aqua-server-1 ../aqua-server-go --tag my-aqua-server-tag:$(date +%s) # this also works, but just creates another image which i dont need
      - name: 2 Build the Docker Image -------------------------
        run: |
          docker build -t aqua-server-1 ../aqua-server-go
          ls -al
          pwd


      - name: 3 Authenticate GHA with AWS -------------------------
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1



      - name: 4 Tag the Image (never been sure why) and then list the images that exist -------------------------
        run: |
          docker images
          docker tag aqua-server-1:latest 35002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name:latest
          sleep 8
          docker images
          docker ps



# # DANHERE 2.5.25 627pm: i think i need that ecr-login step here
# # oohh! i think it's because the previous step hasnt finished yet; so i need a 'depends-on' or 'needs' or something
#
#    714pm, hmm no  it isnt.  here's the msg,
#       The push refers to repository [***.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name]
#       An image does not exist locally with the tag: ***.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name
#
#       but there is indeed a repo with URI: 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name
#         and this image exists: 35002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name
#      IDEAS: maybe the tag name is wrong, or i'm including too much of the repo URI, or i should use the repo NAME not the URL
#       ðŸ¤”ðŸ¤”ðŸ¤”ðŸ¤”ðŸ¤” it has to be either the tag name or the repo name
      - name: 5 Push the Image to ECR -------------------------
        run: |
          echo dwc region is ${{ env.AWS_REGION }} PERIOD
          echo dwc key is ${{ secrets.AWS_ACCESS_KEY_ID }} PERIOD
          echo --- DOCKER IMAGES before PUSH ---
          docker images
          echo -------------------- END --------------------------
          docker push 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr-repo-name:latest
#          docker push aqua-server-1:latest
          


# probably not need -           aws ecr get-login-password --region us-east-1
# probably not needed           aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 535002851677.dkr.ecr.us-east-1.amazonaws.com

#          docker tag aqua-blue5-container:latest 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr:latest
# DAN  2.5:  prior to doing the below *docker push*:
#                 1. DONE - i need to get the keys from my AWS ECR 
#                 2. DONE - log into ECR
#                  2a.  WHY am i doing 'docker login' - what the heck is that; i dont need to log into docker
#                 3. push the image to ECR
#                 4. then start the image running on ECS
# DAN 2.4 8pm:  The below is copilot generated but looks close to what i need re ECR
#  - need to tag the image (docker tag aqua-blue5-container:latest 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr:latest)
#  - then push the image (docker push 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr:latest)
#          docker push 535002851677.dkr.ecr.us-east-1.amazonaws.com/aqua/aqua-ecr:latest
#
# ðŸ”Ž AWS ENV Variables: https://docs.aws.amazon.com/sdkref/latest/guide/settings-reference.html#EVarSettings



# ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§
#  DAN 2.5.25 4pm: the below MAY / MAY NOT be needed.  it is how to actually config creds for aws
#      but i dont need to config them; i just need to pass them, right?
#
# on:
#   push:
#     branches:
#       - main
#
# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}
#
#       - name: Get AWS secrets
#         uses: aws-actions/aws-secretsmanager-get-secrets@v1
#         with:
#           secret-ids: |
#             YOUR_KEY
#           parse-json-secrets: true
#
#       - name: Print all Values
# ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§ðŸŸ§


# DANH 2.3 915pm: from NANA this may help me automate the build of the docker image
#      https://youtu.be/R8_veQiYBjI?si=k3d_ArZs9gH0HKVn&t=1119
#  
#   steps:
#     - uses: actions/checkout@v2
#
#     - name: do the docker image build
#       uses: docker/build-push-action@v2
#       # or maybe actions/somthin-for-docker-buildin (dwc)
#
#     - name: push the docker image to ECR
#       uses: aws-actions/amazon-ecr-login@v2
#